#!/bin/bash

# S2I Assemble Script
#
# This script is based on the S2I assemble script for dotnet 2, with the following extra features:
#
# 1. A Sonarqube scan can be done on the source
# 2. A Snyk scan can be done on the source
# 3. Dotnet tests can be done
# 4. Or a regular build for production of an application image can be done.

set -e
# Include filenames beginning with a '.' when installing the application source code.
shopt -s dotglob

if [ -n "${DOTNET_VERBOSITY}" ]; then
  echo "---> Environment:"
  env | sort
  VERBOSITY_OPTION="-v ${DOTNET_VERBOSITY}"
else
  VERBOSITY_OPTION=""
fi

echo "---> Installing application source..."
if [ -d /tmp/src ]; then
  mv /tmp/src/* ./
fi


if [ ! -z $NPM_MIRROR ]; then
  echo "---> Setting npm mirror"
  npm config set registry $NPM_MIRROR
fi

if [ -n "${PHASE1}" ]; then

# build the application.
npm install @angular/cli@11.0.7
npm install
fi
if [ -n "${PHASE2}" ]; then
mkdir /opt/app-root/dist
mkdir /opt/app-root/dist/lcrb

set

# edit version info files.
sed -i '' \"s/\<!-- UI_GIT_REF --\>/$(git rev-parse --abbrev-ref HEAD)/g\" src/app/components/version-info/version-info-dialog.component.html
sed -i '' \"s/\<!-- UI_GIT_COMMIT --\>/$(git rev-parse HEAD)/g\" src/app/components/version-info/version-info-dialog.component.html
sed -i '' \"s/\<!-- UI_GIT_REPO --\>/$(git remote get-url origin)/g\" src/app/components/version-info/version-info-dialog.component.html
sed -i '' \"s/\<!-- UI_GIT_REPO --\>/$(git log -1 --pretty=format:'%cd')/g\" src/app/components/version-info/version-info-dialog.component.html

npm run build -- --prod --outputPath=/opt/app-root/src/dist





npm run build -- --prod --base-href /lcrb/ --deploy-url /lcrb/ --outputPath=/opt/app-root/src/dist/lcrb
# fix permissions
fix-permissions /opt/app-root/src/dist
fi


